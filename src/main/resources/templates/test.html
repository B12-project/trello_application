<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="/js/board.js" defer></script>
    <link rel="stylesheet" href="/css/style.css">
    <title>WORK FLOW</title>
</head>
<style>
    /* 스타일 정의 */
    body {
        font-family: Arial, sans-serif;
    }
    .board {
        display: flex;
        gap: 10px;
        padding: 20px;
    }
    .column {
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 200px;
        padding: 10px;
        background-color: #f4f4f4;
    }
    .column-header {
        font-weight: bold;
        margin-bottom: 10px;
    }
    .card {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff;
        cursor: move;
    }
    .button-container {
        margin-top: 10px;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #f4f4f4;
        border-bottom: 1px solid #ccc;
    }
    .header .buttons {
        display: flex;
        gap: 5px;
    }
    .header .buttons button {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .header .buttons .add-button {
        background-color: #4CAF50;
        color: white;
    }
    .header .buttons .collab-button {
        background-color: #008CBA;
        color: white;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        width: 300px;
    }
    .modal-header {
        font-size: 1.2em;
        margin-bottom: 10px;
    }
    .modal-body label {
        display: block;
        margin: 5px 0;
    }
    .modal-body input, .modal-body select, .modal-body textarea {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .modal-footer button {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .cancel-button {
        background-color: #f44336;
        color: white;
    }
    .confirm-button {
        background-color: #4CAF50;
        color: white;
    }
</style>
<body>
<div class="header">
    <div>WORK FLOW 프로젝트</div>
    <div class="buttons">
        <button class="add-button" onclick="addColumn()">칼럼 추가하기</button>
        <button class="collab-button">협업 추가하기</button>
    </div>
</div>
<div class="board" id="board">
    <!-- 칼럼이 동적으로 추가될 위치 -->
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">할 일 추가</div>
        <div class="modal-body">
            <label for="taskTitle">제목 *</label>
            <input type="text" id="taskTitle" required>
            <label for="taskStatus">카드 상태</label>
            <select id="taskStatus">
                <option value="시작전">시작전</option>
                <option value="진행중">진행중</option>
                <option value="완료">완료</option>
                <option value="긴급">긴급</option>
            </select>
            <label for="taskContent">내용</label>
            <textarea id="taskContent"></textarea>
            <label for="taskDueDate">마감일자</label>
            <input type="date" id="taskDueDate">
            <label for="taskAssignee">작업자</label>
            <select id="taskAssignee">
                <option value="1">작업자1</option>
                <option value="2">작업자2</option>
                <option value="3">작업자3</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="cancel-button" onclick="closeModal()">취소</button>
            <button class="confirm-button" onclick="addTask()">확인</button>
        </div>
    </div>
</div>

</body>
<script>
    $(document).ready(function () {
        const auth = "eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI3NDcyY2M0Ny1iMzg5LTQzOGItODRhMS0xYWIxZmI5OTVmNjUiLCJzdWIiOiJiMTR1c2VyQGdtYWlsLmNvbSIsImF1dGgiOiJVU0VSIiwiaWF0IjoxNzIwNzk3NjcxLCJleHAiOjE3MjA4MDQ4NzEsInRva2VuVHlwZSI6ImFjY2VzcyJ9.pIu5NaSFWwfBnY1p3wHTU-H_T3hNUMAWKiJZfD6ebsA";

        // 칼럼 데이터를 메모리에 저장할 변수
        var columnMap = {};

        // 카드 데이터를 서버에서 불러옵니다
        function loadCards() {
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/cards',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                success: function (response) {
                    if (Array.isArray(response)) {
                        response.forEach(card => {
                            console.log("카드 status: " + card.status);
                            addCardToColumn(card);
                        });
                    } else {
                        console.error("Expected an array but got:", response);
                    }
                },
                error: function (error) {
                    console.error("Error loading cards:", error);
                    alert("카드 데이터를 불러오는 중 오류가 발생했습니다.");
                },
            });
        }

        // 칼럼 데이터를 서버에서 불러옵니다
        function loadColumns() {
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/columns',
                headers: {
                    'Authorization': 'Bearer ' + auth
                },
                success: function (response) {
                    console.log("Column data:", response);
                    if (Array.isArray(response)) {
                        response.forEach(column => {
                            console.log("컬럼: " + column.columnsStatus);
                            columnMap[column.columnsStatus] = column.id; // 상태를 ID에 매핑
                            addColumnToBoard(column);
                        });
                        initializeSortable(); // 드래그 가능 초기화
                    } else {
                        console.error("Expected an array but got:", response);
                    }
                },
                error: function (error) {
                    console.error("Error loading columns:", error);
                    alert("칼럼 데이터를 불러오는 중 오류가 발생했습니다.");
                },
            });
        }

        // 카드 추가
        function addCardToColumn(card) {
            var columnId = columnMap[card.status]; // 카드 상태에 맞는 칼럼 ID 찾기
            if (columnId) {
                var column = document.getElementById(`column${columnId}`);
                if (column) {
                    var newCard = document.createElement('div');
                    newCard.className = 'card';
                    newCard.textContent = card.title;
                    column.appendChild(newCard); // 칼럼의 마지막에 카드 추가
                } else {
                    console.error("Column with ID " + columnId + " not found.");
                }
            } else {
                console.error("No column found for status: " + card.status);
            }
        }

        // 칼럼을 보드에 추가
        function addColumnToBoard(columnData) {
            var board = document.getElementById('board');
            var newColumn = document.createElement('div');
            newColumn.className = 'column';
            newColumn.id = `column${columnData.id}`;
            newColumn.innerHTML = `<div class="column-header">${columnData.columnsStatus}</div>
            <button class="add-button" onclick="showModal()">할 일 추가하기</button>`;
            board.appendChild(newColumn);

            // 칼럼에 포함된 카드들을 추가
            if (Array.isArray(columnData.cardList)) {
                columnData.cardList.forEach(card => {
                    var newCard = document.createElement('div');
                    newCard.className = 'card';
                    newCard.textContent = card.title;
                    newColumn.appendChild(newCard); // 칼럼의 마지막에 카드 추가
                });
            } else {
                console.error("Expected an array of cards but got:", columnData.cardList);
            }
        }

        // 칼럼 및 보드를 드래그 가능하게 초기화
        function initializeSortable() {
            var columns = document.querySelectorAll('.column');
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'shared',
                    animation: 150
                });
            });

            new Sortable(document.getElementById('board'), {
                animation: 150,
                draggable: '.column'
            });
        }

        // 모달 열기
        function showModal() {
            document.getElementById('modal').style.display = 'flex';
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // 할 일 추가
        function addTask() {
            var title = document.getElementById('taskTitle').value;
            var status = document.getElementById('taskStatus').value;
            var content = document.getElementById('taskContent').value;
            var dueDate = document.getElementById('taskDueDate').value;
            var assignee = document.getElementById('taskAssignee').value;

            if (!title) {
                alert("제목은 필수 항목입니다.");
                return;
            }

            // task 객체 생성
            var task = {
                title: title,
                content: content,
                deadDate: dueDate ? new Date(dueDate).toISOString() : null,
                assigneeId: assignee ? parseInt(assignee) : null,
                status: status
            };

            console.log("Created task:", task);

            // cardDto 객체 생성
            var cardDto = {
                title: title,
                content: content,
                deadDate: dueDate ? new Date(dueDate).toISOString() : null,
                assigneeId: assignee ? parseInt(assignee) : null,
                status: status,
                tasks: [task]
            };

            console.log("Created cardDto with task:", cardDto);

            addCard(cardDto);
            closeModal();
        }

        // 카드 추가 기능 (백엔드와 통신)
        function addCard(cardDto) {
            console.log("Sending cardDto:", cardDto);

            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/cards',
                crossOrigin: true,
                contentType: 'application/json',
                data: JSON.stringify(cardDto),
                success: function (response) {
                    alert("생성 완료");
                    addCardToColumn(response); // 응답 받은 카드로 칼럼에 추가
                },
                error: function (error) {
                    console.error("Error:", error);
                    alert("다시 입력해 주세요");
                },
            });
        }

        // 페이지 로드 후 카드 및 칼럼 데이터 로드

        loadCards();
        loadColumns();
    });


</script>
</html>
